var featureList,map=null,layerControl=null,NameApp="Mapa Politechniki Łódzkiej 2.0";L.Map=L.Map.extend({openPopup:function(t,e,a){if(!(t instanceof L.Popup)){var s=t;t=new L.Popup(a).setContent(s)}return e&&t.setLatLng(e),this.hasLayer(t)?this:(this._popup=t,this.addLayer(t))}}),$.urlParam=function(t){var e=new RegExp("[?&]"+t+"=([^&#]*)").exec(window.location.href);return null===e?null:decodeURI(e[1])||0};var highlight=L.geoJson(null),highlightStyle={stroke:!1,fillColor:"#00FFFF",fillOpacity:.7,radius:10},groupSearch=[],buildingSearch=[],unitSearch=[],wikimediaLayer=L.tileLayer("https://{s}.tile.osm.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:12}),sateliteLayer=L.tileLayer.wms("https://mapy.geoportal.gov.pl/wss/service/img/guest/ORTO/MapServer/WMSServer",{maxZoom:18,minZoom:12,layers:"Raster",format:"image/png",transparent:!0}),baseLayers={Mapa:wikimediaLayer,Satelita:sateliteLayer},markerClusters=new L.MarkerClusterGroup({spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,zoomToBoundsOnClick:!0,disableClusteringAtZoom:17,iconCreateFunction:function(t){if(t._zoom<17)return new L.DivIcon({html:"",className:""});var e=t.getChildCount(),a=" marker-cluster-";return a+=10>e?"small":100>e?"medium":"large",new L.DivIcon({html:"<div><span>"+e+"</span></div>",className:"marker-cluster"+a,iconSize:new L.Point(40,40)})}}),mKampusA=new L.popup({pane:"shadowPane",closeButton:!1,closeOnClick:!1,autoClose:!1,className:"campusName",autoPan:!1}).setContent("KAMPUS A").setLatLng([51.75380837226329,19.452259540557858]),mKampusB=new L.popup({pane:"shadowPane",closeButton:!1,closeOnClick:!1,autoClose:!1,className:"campusName",autoPan:!1}).setContent("KAMPUS B").setLatLng([51.74673451706946,19.453911781311035]),mKampusC=new L.popup({pane:"shadowPane",closeButton:!1,closeOnClick:!1,autoClose:!1,className:"campusName",autoPan:!1}).setContent("KAMPUS C").setLatLng([51.74575139599555,19.44955587387085]),mKampusD=new L.popup({pane:"shadowPane",closeButton:!1,closeOnClick:!1,autoClose:!1,className:"campusName small",autoPan:!1}).setContent("KAMPUS D").setLatLng([51.74951105428582,19.461228847503662]),mKampusE=new L.popup({pane:"shadowPane",closeButton:!1,closeOnClick:!1,autoClose:!1,className:"campusName small",autoPan:!1}).setContent("KAMPUS E").setLatLng([51.74685408438942,19.459190368652344]),mKampusF=new L.popup({pane:"shadowPane",closeButton:!1,closeOnClick:!1,autoClose:!1,className:"campusName",autoPan:!1}).setContent("KAMPUS F").setLatLng([51.77909249416757,19.494391679763794]),groups={},buildings={},units={},events={},colors={a:{color:"#ff0404"},b:{color:"#800080"},c:{color:"#00ff00"},d:{color:"#0080ff"},e:{color:"#0000cc"}};function Group(t,e,a,s,i){this.shortname=t,this.simplename=a,this.name=e,this.aliases=s,this.color=i,this.buildings={},this.layer=L.geoJson(null),this.layer.options.group=this,this.search={},this.bloodhound=null,groupSearch.push({shortname:this.shortname,name:this.name,alias:this.aliases,simplename:this.simplename,source:"groups"}),this.addBuilding=function(t){this.buildings[t.shortname]=t},this.showOnMap=function(t){for(var e in t||history.pushState({type:"group",value:this.shortname},this.name+" - "+NameApp,"?group="+this.shortname),document.title=this.name+" - "+NameApp,markerClusters.clearLayers(),this.buildings)this.buildings[e].layer&&(this.buildings[e].layer.options.color=this.color,this.buildings[e].layer.options.fillColor=this.color,this.buildings[e].icon=this.shortname,this.buildings[e].showOnMap(!1,!1,!0));map.flyToBounds(markerClusters.getBounds())}}function Building(t,e,a,s,i,o,n){this.shortname=t,this.name=e,this.aliases=a,this.address=s,this.entriesCords=L.GeoJSON.coordsToLatLngs(i),this.entries=[],this.icon="entrance",this.customIcon=n||null,this.geometry=L.GeoJSON.coordsToLatLngs(o),this.groups={},buildingSearch.push({shortname:this.shortname,name:this.name,alias:this.aliases,address:this.address,source:"buildings"}),this.addGroup=function(t,e){if(this.groups[t.shortname])return null!==e&&e(this.groups[t.shortname]),this;t.addBuilding(this);var a=this;return this.groups[t.shortname]={group:t,units:{},addUnit:function(t,e){return this.units[t.shortname]?this:(this.units[t.shortname]=t,t.addBuilding(a,e),this.group.search[t.shortname]||(this.group.search[t.shortname]={shortname:t.shortname,name:t.name,alias:t.aliases,web:t.web,source:"units"}),this)}},null!==e&&e(this.groups[t.shortname]),this},this.showOnMap=function(t,e,a,s,i){if(this.layer){for(var o in t&&(markerClusters.clearLayers(),layerControl.clear()),a||(this.layer.options.color="black",this.layer.options.weight=2,this.layer.options.opacity=1,this.layer.options.fillOpacity=.3,this.layer.options.fillColor=colors[this.shortname[0]].color,this.icon="entrance"),this.entries=[],this.entriesCords){var n=this.entriesCords[o];this.entries.push(L.marker(n,{icon:L.icon({iconUrl:"assets/img/"+(this.customIcon?this.customIcon:this.icon)+".png",iconSize:[24,28],iconAnchor:[12,28],popupAnchor:[0,-25]}),title:this.name+" - Wejście "+(parseInt(o)+1),riseOnHover:!0}).on("click",this.showModal,this)),isNaN(s)?highlight.clearLayers():null!==s&&-1!==s?s==o&&highlight.addLayer(L.circleMarker(n,highlightStyle)):highlight.addLayer(L.circleMarker(n,highlightStyle))}markerClusters.addLayer(this.layer),markerClusters.addLayers(this.entries),t&&map.flyToBounds(markerClusters.getBounds()),e&&this.showModal(i)}},this.showModal=function(t){null===t||t&&(!0===t||null===t.type)||history.pushState({type:"building",value:this.shortname},this.name+" - "+NameApp,"?building="+this.shortname),document.title=this.name+" - "+NameApp;var e=this,a="<table class='table table-striped table-bordered table-condensed'><tr><th width='30%;'>Budynek</th><td>"+e.name+"</td></tr>";for(var s in e.address&&(a+="<tr><th>Adres</th><td>"+e.address+"</td></tr>"),e.groups){for(var i in a+="<tr><th>"+e.groups[s].group.name+"</th><td>",e.groups[s].units){var o="",n=e.groups[s].units[i].buildings[e.shortname].entry;-1!==n&&(o=" <b style='color:#7D223F'>Tylko wejście "+ ++n+"</b>"),a+="<a onclick=\"javascript:window.units['"+i+"'].showOnMap();\">"+e.groups[s].units[i].name+"</a>"+o,a+="<hr style='margin:5px 15px;'/>"}a+="</td></tr>"}var r=function(){$("#feature-title").html(e.name),$("#feature-info").html(a),$("#feature-back").html(""),$("#featureModal").modal("show")};$("#featureModal").hasClass("fade in")?($("#featureModal").modal("hide"),setTimeout(r,400)):r()},this.layer=L.polygon(this.geometry,{fillOpacity:.5}).on("click",this.showModal,this)}function Unit(t,e,a,s,i){this.shortname=t,this.name=e,this.aliases=a,this.web=s,this.icon=i,this.buildings={},this.addBuilding=function(t,e){this.buildings[t.shortname]={building:t,entry:e}},this.showOnMap=function(t){for(var e in t||history.pushState({type:"unit",value:this.shortname},this.name+" - "+NameApp,"?unit="+this.shortname),document.title=this.name+" - "+NameApp,markerClusters.clearLayers(),highlight.clearLayers(),layerControl.clear(),this.buildings)if(this.buildings[e].building.layer){this.buildings[e].building.layer.options.color="blue",this.buildings[e].building.layer.options.fillColor="blue",this.buildings[e].building.icon="entrance";var a=this.buildings[e].entry;this.buildings[e].building.showOnMap(!1,!1,!0,a)}map.flyToBounds(markerClusters.getBounds()),this.showModal()},this.showModal=function(t){var e=this,a="<table class='table table-striped table-bordered table-condensed'><tr><th>Jednostka</th><td>"+e.name+"</td></tr>";e.telephone&&(a+="<tr><th>Telefon</th><td>"+e.telephone+"</td></tr>"),e.web&&(a+="<tr><th>Strona</th><td><a class='url-break' href='"+e.web+"' target='_blank'>"+e.web+"</a></td></tr>");var s="";for(var i in e.buildings){var o="",n=e.buildings[i].entry;-1!==n&&(o="<b style='color:#7D223F'>("+ ++n+")</b>"),s+="<a onclick=\"javascript:window.buildings['"+i+"'].showOnMap(true,true);\">"+e.buildings[i].building.name+o+"</a> "}a+="<tr><th>Budynki</th><td>"+s+"</td></tr>",a+="<table>";var r=function(){$("#feature-title").html(e.name),$("#feature-info").html(a),t?$("#feature-back").html("<a onclick=\"javascript:window.buildings['"+t+'\'].showModal();" class="btn btn-default">Wróć do budynku</a>'):$("#feature-back").html(""),$("#featureModal").modal("show")};$("#featureModal").hasClass("fade in")?($("#featureModal").modal("hide"),setTimeout(r,400)):r()}}function Event(t,e,a,s,i,o){this.id=t,this.title=e,this.desc=a,this.dateFrom=s,this.dateTo=i,this.geometry=L.latLng(o.coordinates.lat,o.coordinates.long),this.showModal=function(t){null===t||t&&(!0===t||null===t.type)||history.pushState({type:"event",value:this.shortname},this.title+" - "+NameApp,"?event="+this.id);var e="<table class='table table-striped table-bordered table-condensed'><tr><th width='15%'>Tytuł</th><td>"+this.title+"</td></tr>";e+="<tr><th>Data rozpoczęcia</th><td>"+this.dateFrom.asString+"</td></tr>",e+="<tr><th>Data zakończenia</th><td>"+this.dateTo.asString+"</td></tr>",e+="<tr><th>Opis</th><td>"+this.desc+"</td></tr>",$("#feature-title").html("Wydarzenie"),$("#feature-info").html(e),$("#feature-back").html(""),$("#featureModal").modal("show"),map.flyTo(this.geometry,17),highlight.clearLayers(),highlight.addLayer(L.circleMarker(this.geometry,highlightStyle))},this.layer=L.marker(this.geometry,{icon:L.icon({iconUrl:"assets/img/event.png",iconSize:[24,28],iconAnchor:[12,28],popupAnchor:[0,-25]}),title:this.title,riseOnHover:!0}).on("click",this.showModal,this).addTo(map),L.marker(this.geometry,{pane:"shadowPane",icon:cssIcon}).addTo(map)}function loadError(){$("#loading").hide();$("#feature-title").html("Błąd"),$("#feature-info").html("<table class='table table-striped table-bordered table-condensed'><tr><th width='30%;' colspan='2'>Błąd ładowania mapy</th></tr><tr><td colspan='2'>Proszę odświeżyć stronę lub spróbować ponownie później</td></tr>"),$("#featureModal .modal-footer").html(""),$("#featureModal").modal("show")}window.onpopstate=function(t){null===t.state||null===t.state.type?(map.removeLayer(active),active=null,map.addLayer(all),$("#featureModal").modal("hide")):"event"===t.state.type?null!==events[t.state.value]&&events[t.state.value].showModal(!0):"unit"===t.state.type?null!==units[t.state.value]&&units[t.state.value].showOnMap(!0):"building"===t.state.type?null!==buildings[t.state.value]&&buildings[t.state.value].showOnMap(!0,!0,!1,null,!0):"group"===t.state.type&&null!==groups[t.state.value]&&(map.removeLayer(active),groups[t.state.value].recv=!0,map.addLayer(groups[t.state.value].layer))};var cssIcon=L.divIcon({className:"css-icon",html:'<div class="gps_ring"></div>',iconSize:[22,22]});$.getJSON("data/groups.json",(function(t){for(var e in t)groups[e]=new Group(e,t[e].name,t[e].simplename,t[e].aliases,t[e].color)})).done((function(){$.getJSON("data/buildings.json",(function(t){for(var e in t)buildings[e]=new Building(e,t[e].name,t[e].alias,t[e].address,t[e].entries,t[e].geometry,t[e].icon)})).done((function(){$.getJSON("data/units.json",(function(t){for(var e in t){for(var a in t[e].relations);for(var s in units[e]=new Unit(e,t[e].name,t[e].aliases,t[e].web,a),t[e].relations)for(var i in t[e].relations[s]){var o=t[e].relations[s][i],n=o.indexOf(":");-1!==n&&(n=o.split(":")[1],o=o.split(":")[0]),buildings[o].addGroup(groups[s],(function(t){t.addUnit(units[e],n)}))}}})).done((function(){var t={Grupy:{Wszystko:all}};for(var e in groups)key='<span data-toggle="tooltip" data-placement="left" data-container="body" title="'+groups[e].name+"\"><img src='assets/img/"+groups[e].shortname+".png' width='24' height='28'>&nbsp;"+groups[e].simplename+"</span>",t.Grupy[key]=groups[e].layer;layerControl=L.control.groupedLayers(baseLayers,t,{collapsed:isCollapsed,exclusiveGroups:["Grupy"]}).addTo(map);var a=$(".leaflet-control-layers")[0];L.Browser.touch?L.DomEvent.disableClickPropagation(a):L.DomEvent.disableClickPropagation(a).disableScrollPropagation(a),map.addLayer(all),loadSearch(),$('[data-toggle="tooltip"]').tooltip(),$.getJSON("proxy.php",(function(t){for(var e in t){var a=t[e];events[a.eventId]=new Event(a.eventId,a.title,a.description,a.dateFrom,a.dateTo,a.geometry)}})).done((function(){var t=$.urlParam("event");null!==t&&null!==events[t]&&events[t].showModal()}));var s=$.urlParam("unit");null!==s&&null!==units[s]&&units[s].showOnMap();var i=$.urlParam("building");null!==i&&null!==buildings[i]&&buildings[i].showOnMap(!0,!0);var o=$.urlParam("group");null!==o&&null!==groups[o]&&(map.removeLayer(active),map.addLayer(groups[o].layer))})).fail(loadError)})).fail(loadError)})).fail(loadError);var all=L.geoJson(null),active=all;map=L.map("map",{zoom:15,center:[51.748727,19.455349],layers:[wikimediaLayer,mKampusA,mKampusB,mKampusC,mKampusD,mKampusE,mKampusF,markerClusters,highlight],zoomControl:!1,attributionControl:!1});function doStuff(t){console.log(t.latlng);var e=t.layerPoint.x,a=t.layerPoint.y;console.log([e,a]);var s=L.point(e,a);console.log("Point in x,y space: "+s);var i=map.layerPointToLatLng(s);console.log("Point in lat,lng space: "+i)}var CanvasLayer=L.GridLayer.extend({createTile:function(t){var e=L.DomUtil.create("canvas","leaflet-tile"),a=this.getTileSize();e.width=a.x,e.height=a.y,console.log(e.width);e.getContext("2d");return e}});function syncSidebar(){var t=$("#feature-list").find("tbody");t.empty();var e=[];for(var a in buildings)if(map.hasLayer(buildings[a].layer))for(var s in buildings[a].groups)if(active===all||buildings[a].groups[s].group.layer===active)for(var i in buildings[a].groups[s].units)if(-1===e.indexOf(i)){e.push(i);var o=buildings[a].groups[s].units[i];buildings[a].customIcon?buildings[a].customIcon:buildings[a].icon;t.append('<tr class="feature-row" unit="'+o.shortname+'"><td class="feature-shortname"><img width="16" height="18" src="assets/img/'+o.icon+'.png" title="'+o.shortname+'"></td><td class="feature-name">'+o.name+'</td><td style="vertical-align: middle;"><i class="fa fa-chevron-right pull-right"></i></td></tr>')}for(var n in events){var r=events[n];t.append('<tr class="feature-row" event="'+r.id+'"><td style="vertical-align: middle;"><img width="16" height="18" src="assets/img/event.png"></td><td class="feature-name">'+r.title+'</td><td style="vertical-align: middle;"><i class="fa fa-chevron-right pull-right"></i></td></tr>')}(featureList=new List("features",{valueNames:["feature-shortname"]})).sort("feature-shortname",{order:"asc"})}map.on("overlayadd",(function(t){if(t.layer===all){for(var e in markerClusters.clearLayers(),highlight.clearLayers(),buildings)buildings[e].showOnMap();map.flyTo(map.options.center,map.options.zoom),active!==all&&(document.title=NameApp,history.replaceState(null,NameApp,"index.html")),active=all,syncSidebar()}else t.layer&&t.layer.options.group&&(t.layer.options.group.recv?(t.layer.options.group.recv=!1,t.layer.options.group.showOnMap(!0)):t.layer.options.group.showOnMap(),active=t.layer,syncSidebar())})),map.on("zoomend",(function(t){t.target._zoom<15?(mKampusA._map&&mKampusA._close(),mKampusB._map&&mKampusB._close(),mKampusC._map&&mKampusC._close(),mKampusD._map&&mKampusD._close(),mKampusE._map&&mKampusE._close()):(mKampusA._map||mKampusA.openOn(map),mKampusB._map||mKampusB.openOn(map),mKampusC._map||mKampusC.openOn(map),mKampusD._map||mKampusD.openOn(map),mKampusE._map||mKampusE.openOn(map))}));